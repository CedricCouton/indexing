## Projector

Application developers can use Data-Description-Language (DDLs) to define one
or more secondary index on primary Key-Value (KV) data-store. Typically DDLs
defined by applications will specify an expression that can be applied on each
JSON-document that is inserted or updated in the KV store. DDL-expression will
take the document as input, evaluate them, generate a json value which shall
be treated as **secondary-keys** for secondary indexes.

Following is an overview of the projector component,

* projector is a stateless component in the system, that is, it is not backed
  by any persistent storage.
* once a projector component starts up,
  * spawn an admin server that will wait for admin-messages.

* admin server
  * will wait for a new stream request
    `{topic, restart-timestamp, indexids}` to start UPR connections.
  * get index definitions that are applicable for projector connection.

* evaluate each document using index's DDL expression and generate
  KeyVersions that will be pushed to the router component.

### Mutation messages

* Data Messages
  * UprMutation, for document insertion and deletion.
  * UprDeletion, for document deletion.
  * UpsertDeletion, locally generated by router to delete older key-version.
* Control messages
  * Sync message, to broadcast current {vbuuid, seqno}
  * StreamBegin message, to indicate a vbucket stream has started.
  * StreamEnd message, to indicate a vbucket stream has ended.

For more information refer to [Mutation][] document.

### SYNC message

For every vbucket, projector will use DELETE (corresponding to upr-deletion)
and LOCAL-DELETE (corresponding to upr-insertion to delete the old key) to
piggy-back SYNC message to router, which will then publish the message to all
subscribers on that topic.

Note that the projector can periodically send out a SYNC message to router
to ensure that each local-indexer and Index-Coordinator to synchronize with
their high watermark timestamp.

Following could be used as trigger for SYNC message,
* UpsertDeletion, in case older document version is not available from UPR.
* UprDeletion.
* UPR_SNAPSHOT_MARKER from UPR stream.
* periodic timer.

[Mutation]: mutation.md
